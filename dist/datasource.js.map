{"version":3,"sources":["../src/datasource.js"],"names":["DEFAULT","HttpsqlDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","metricParamList","options","from","range","Date","getTime","to","target_list","targets","filter","target","alias","metric","hide","Promise","resolve","data","self","url_list","map","params","param_list","p","value","replace","scopedVars","join","scope","doRequest","all","then","results","forEach","result","i","res","columns","Object","keys","datatype","push","c","text","indexOf","rows","e","label","status","message","title","metrics","desc","substring","split","trim","method","datasourceRequest"],"mappings":"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","file":"datasource.js","sourcesContent":["var DEFAULT = '* select *';\n\nexport class HttpsqlDatasource {\n\n\tconstructor(instanceSettings, $q, backendSrv, templateSrv) {\n\t\tthis.type = instanceSettings.type;\n\t\tthis.url = instanceSettings.url;\n\t\tthis.name = instanceSettings.name;\n\t\tthis.q = $q;\n\t\tthis.backendSrv = backendSrv;\n\t\tthis.templateSrv = templateSrv;\n\t\tthis.withCredentials = instanceSettings.withCredentials;\n\t\tthis.headers = {'Content-Type': 'application/json'};\n\t\tif (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) \n\t\t\tthis.headers['Authorization'] = instanceSettings.basicAuth;\n\n\t\tthis.metricParamList = {};\n\t}\n\n\tquery(options) {\n\t\tvar from = options.range && options.range.from && new Date(options.range.from).getTime();\n\t\tvar\tto = options.range && options.range.to && new Date(options.range.to).getTime();\n\t\t\n\t\tvar target_list = options.targets.filter((target) => target.alias && target.alias != DEFAULT && target.metric && target.metric != DEFAULT && !target.hide);\n\t\tif (target_list.length == 0)\t\n\t\t\treturn Promise.resolve({data: []});\n\n\t\tvar self = this;\n\t\tvar url_list = target_list.map(function (target) {\n\t\t\tvar params = target.param_list.map(function (p) {\n\t\t\t\tvar value = self.templateSrv.replace(target.params[p], options.scopedVars, 'regex');\n\t\t\t\treturn p + '=' + (value || '');\n\t\t\t}).join('&') || '';\n\t\t\treturn `/${target.alias}/${target.metric}?${params}&from=${target.from || from}&to=${target.to || to}&json`;\n\t\t});\n\n\t\tvar scope = url_list.map((url) => this.doRequest(url));\n\t\n\t\treturn Promise.all(scope).then(function (results) {\n\t\t\tvar data =  [];\n\t\t\t\n\t\t\tresults.forEach(function (result, i) {\n\t\t\t\tvar res = result.data || [];\n\t\t\t\tif (res.length == 0)\n\t\t\t\t\treturn;\n\t\t\t\t\n\t\t\t\tvar target = target_list[i];\n\t\t\t\tvar columns = Object.keys(res[0]);\n\n\t\t\t\tif (target.datatype == 'table') {\n\t\t\t\t\tdata.push({\n\t\t\t\t\t\tcolumns: columns.map((c) => new Object({text: c, type: c.indexOf('time') != -1 ? 'time' : 'string'})),\n\t\t\t\t\t\trows: res.map((e, i) => columns.map((c) => res[i][c])),\n\t\t\t\t\t\ttype: 'table'\n\t\t\t\t\t})\n\t\t\t\t} else {\n\t\t\t\t\tdata.push({\n\t\t\t\t\t\ttarget: target.label || `${target.alias}/${target.metric}`,\n\t\t\t\t\t\trows: res.map((e, i) => columns.map((c) => res[i][c])),\n\t\t\t\t\t\ttype: 'timeserie'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\t\t\n\t\t\t});\n\n\t\t\treturn Promise.resolve({data});\n\t\t})\n\t\n\t}\n\n\ttestDatasource() {\n\t\treturn this.doRequest('/')\n\t\t\t.then(res => res.status == 200 ? {status: 'success', message: 'OK', title: 'Success'} : {status: 'error', message: 'Fail', title: 'Error'});\n\t}\n\n\tgetAliasList () {\n\t\treturn this.doRequest('/').then((res) => res.data);\n\t}\n\n\tgetMetricList(alias) {\n\t\tif (alias == DEFAULT)\n\t\t\treturn Promise.resolve([]);\n\n\t\tvar self = this;\n\t\treturn this.doRequest('/' + alias)\n\t\t\t.then(function (res) {\n\t\t\t\tvar metrics = res.data;\n\t\t\t\tfor (var metric in metrics) {\n\t\t\t\t\tif (!self.metricParamList[metric]) {\n\t\t\t\t\t\tvar desc = metrics[metric] || '';\n\t\t\t\t\t\tself.metricParamList[metric] = desc.substring(desc.indexOf(':') + 1, desc.indexOf('.')).split(',').map((e) => e.trim());\n\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\t\treturn Object.keys(metrics);\n\t\t\t});\n\t}\n\n\tgetMetricParamList(metric) {\n\t\treturn this.metricParamList[metric] || [];\n\t}\n\n\tdoRequest(url) {\n\t\tvar options = {\n\t\t\turl: this.url + url,\n\t\t\twithCredentials: this.withCredentials,\n\t\t\theaders: this.headers,\n\t\t\tmethod: 'GET'\n\t\t}\n\t\t\n\t\treturn this.backendSrv.datasourceRequest(options);\n\t}\n}\n"]}